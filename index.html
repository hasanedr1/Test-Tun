<button id="startPipeline">Start Pipeline</button>
<p id="status"></p>

<script>
const statusEl = document.getElementById("status");

document.getElementById("startPipeline").onclick = async () => {
  statusEl.innerText = "Pipeline wird gestartet...";

  try {
    const startRes = await fetch("/api/start-pipeline", { method: "POST" });

    if (!startRes.ok) {
      const text = await startRes.text();
      statusEl.innerText = "Fehler beim Starten: " + text;
      return;
    }

    const { runId } = await startRes.json();
    if (!runId) {
      statusEl.innerText = "Fehler: Keine runId erhalten";
      return;
    }

    statusEl.innerText = "Pipeline gestartet, runId: " + runId;

    const interval = setInterval(async () => {
      try {
        const res = await fetch(`/api/pipeline-status?runId=${runId}`);
        if (!res.ok) {
          const text = await res.text();
          statusEl.innerText = "Fehler beim Abrufen: " + text;
          clearInterval(interval);
          return;
        }

        const data = await res.json();
        statusEl.innerText = `Status: ${data.state}, Ergebnis: ${data.result}`;
        if (data.state?.toLowerCase() === "completed") clearInterval(interval);

      } catch (err) {
        statusEl.innerText = "Fehler beim Abrufen: " + err.message;
        clearInterval(interval);
      }
    }, 5000);

  } catch (err) {
    statusEl.innerText = "Fehler beim Starten: " + err.message;
  }
};
</script>
