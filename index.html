<button id="startPipeline">Pipeline starten</button>
<p id="status"></p>

<script>
const statusEl = document.getElementById("status");

document.getElementById("startPipeline").onclick = async () => {
  statusEl.innerText = "Pipeline wird gestartet...";

  try {
    const startRes = await fetch(
      "https://azure-pipeline-trigger.vercel.app/api/start-pipeline",
      { method: "POST" }
    );

    const { runId } = await startRes.json();

    const interval = setInterval(async () => {
      try {
        const res = await fetch(
          `https://azure-pipeline-trigger.vercel.app/api/pipeline-status?runId=${runId}`
        );

        const data = await res.json();

        // Immer den aktuellen state anzeigen
        statusEl.innerText = `Status: ${data.state}` + (data.result ? `, Ergebnis: ${data.result}` : "");

        // Wenn fertig, Interval stoppen
        if (data.state === "completed") {
          clearInterval(interval);
          if (data.result === "succeeded") {
            statusEl.innerText = "✅ Test PASSED";
          } else {
            statusEl.innerText = `❌ Test ${data.result.toUpperCase()}`;
          }
        }
      } catch (err) {
        console.error(err);
        statusEl.innerText = "Fehler beim Abrufen des Pipeline-Status";
        clearInterval(interval);
      }
    }, 5000);

  } catch (err) {
    console.error(err);
    statusEl.innerText = "Fehler beim Starten der Pipeline";
  }
};
</script>
